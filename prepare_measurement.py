import tkinter as tk
from tkinter import filedialog, messagebox
import os
import shutil

root = tk.Tk()
root.withdraw()

inifile = """[SM\PX]
isprotein=0
is_deltattt_sm=0
issmartbkg_sm=0
issinglewave_sm=0
ishklcheck_sm=0
is2ndcycle_sm=1
iscomputecomp_sm=1
ismtzexport_sm=0
isxdsexport_sm=0
iscbfexport_sm=0
iaddesperantoheaderlinestocbf_sm=0
iaddxdsinpheaderlinestocbf_sm=0
iuse_multimodule_description_for_flat_detectorsincbf_sm=0
isdtrekexport_sm=0
ismosflmexport_sm=0
isdenzoexport_sm=0
iscopyimgexport_sm=0
useuserfoldercopyimgexportoptions_sm=0
ctargetpathcopyimgexportoptions_sm=C:\XcaliburData
is3dpeakhunting_sm=0
is3dpeakhunting_microed_sm=1
isrungral_sm=1
is_lessruns_red_2=1
useaxes_sm=0
isnoncentrosymmetric_sm=0
iminlatt_sm=2
imaxlatt_sm=120
imaxtime_sm=400
overlaptype_sm=0
overlaptype_s2_sm=-1
isskiprefframes_sm=0
isproffitpredictuncertainty_sm=0
completenessgoal_sm=1.000
difflimitioversig_sm=2.000
modulescaling_policy_smpx=0
watchdog_policy_smpx=0
externalred_dcconcurrent_sm=0
externalred_dcautoanalyse_sm=0
reslimit4datared_sm=0
is_deltattt_px=1
issmartbkg_px=1
issinglewave_px=1
ishklcheck_px=1
is2ndcycle_px=1
iscomputecomp_px=1
ismtzexport_px=0
isxdsexport_px=0
iscbfexport_px=0
iaddesperantoheaderlinestocbf_px=0
iaddxdsinpheaderlinestocbf_px=0
iuse_multimodule_description_for_flat_detectorsincbf_px=0
isdtrekexport_px=0
ismosflmexport_px=0
isdenzoexport_px=0
iscopyimgexport_px=0
useuserfoldercopyimgexportoptions_px=0
ctargetpathcopyimgexportoptions_px=C:\XcaliburData
is3dpeakhunting_px=0
is3dpeakhunting_microed_px=1
isrungral_px=1
useaxes_px=2
iminlatt_px=30
imaxlatt_px=250
overlaptype_px=1
overlaptype_s2_px=-1
imaxtime_px=1200
isskiprefframes_px=1
isproffitpredictuncertainty_px=0
completenessgoal_px=0.970
difflimitioversig_px=2.000
externalred_dcconcurrent_policy_px=0
externalred_dcconcurrent_px=0
externalred_dcautoanalyse_policy_px=0
externalred_dcautoanalyse_px=0
autoanalyseicerings_px=1
reslimit4datared_px=1
isautoshape=0
iisumffactive_sm_2=1
iumffmaxpeakset_sm_2=400
dumffmaxtime_sm=5.000
iis_usetabscr_sm_1_0=1
isgandolfi=0
AUTOCHEM41_CAP_TRACKS_BEST_RED=0
AUTOCHEM41_CAP_TRACKS_BEST_ONLINE=1
AUTOCHEM41_REFINEHKLF5=0
iAUTOSEARCHOLEX2_GLOBAL=1
iAUTOSEARCHAUTOCHEM_GLOBAL=1
iASKUSER_WHENNWVERSONFOUND_GLOBAL=1
iBINDOLEX2LIST_AND_ACLIST_GLOBAL=1
gandolfi background range as LONG*100=2500
ilaunchstructureexplorer=0
iappendfastphirun=0
issortrun=0
isreversedscans=0
thickmholderpolicy2_px=2
thickmholderpolicy2_sm=0
thickmholderdegfactor_px=300
thickmholderdegfactor_sm=300
thickmholder_currentstate=0
isuserlistdlg_42orhigher=1
issetuserbeforeexperiment=0
issuppressnamingauto=0
powder_modeofpixelextr=3
powder_bilinearinterpolation_mode=1
powder_is_bilinearinterpolation_db_interpolation=1
iszipafterexperimentpolicy=0
numofdayszipafterexperimentoptionspolicy=1
iszipcommlogszipafterexperimentoptionspolicy=0
usemultizipframeszipafterexperimentoptionspolicy=0
usemultizipbigzipafterexperimentoptionspolicy=0
isopendestzipafterexperimentoptionspolicy=0
usemultizipallzipafterexperimentoptionspolicy=0
ismovetoselectedfolderzipafterexperimentoptionspolicy=0
ctargetpathzipafterexperimentoptionspolicy=
useuserfolderzipafterexperimentoptionspolicy=0
is_newplot_smpx=1
is_SFAC_ED_smpx=1
e_type_of_SFAC_smpx=0
iszipafterexperiment=0
numofdayszipafterexperimentoptions=1
iszipcommlogszipafterexperimentoptions=0
usemultizipframeszipafterexperimentoptions=0
usemultizipbigzipafterexperimentoptions=0
isopendestzipafterexperimentoptions=0
usemultizipallzipafterexperimentoptions=0
ismovetoselectedfolderzipafterexperimentoptions=0
ctargetpathzipafterexperimentoptions=
useuserfolderzipafterexperimentoptions=0
isspongemode=0
mu_calc_with_formula_variants=1
[CCD]
irecmovie_current_ccd=1
irecmovie_policy_ccd=1
iishpmovie_current_ccd=0
ifastmoviemode_ccd_improved=0
imovieposition_ccd=1
imovieposition_ccd_rev1=1
idenoisemovie_ccd=0
imoviedenoise_algsamples_ccd=5
hypix_extended_ccd_files=0
[JetShadow]
use=0
parameters=30.000000 0.000000 13.000000 6.000000
icingzonewarning=1
[CrystalHolderShadow_Magnetic_pin]
use=1
parameters=1.000000 2.000000
[Restart concurrent]
mode=0
[RED Screen and zoom]
X_Screen=2560
Y_Screen=1440
Zoom10000=9029
ZoomType=0
[EwaldPro]
Group1 tooltip=Group1
Group2 tooltip=Group2
Group3 tooltip=Group3
Group4 tooltip=Group4
Group5 tooltip=Group5
Number of groups=5
Lattice overlay=1
Center cross=0
[USER Screen and zoom]
X_Screen=2560
Y_Screen=1440
Zoom10000=12770
ZoomType=1"""

byte_data = b'\x04\x00\x01\x00\x18\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00oP\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x9a\x99\x99\x99\x99\x99\xa9?\x00\x00\x00\x00\x00\x00\xe0?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1c@\x00\x00\x00\x00\x00\x80f@\x00\x00\x00\x00\x00\x000\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0?2\x00\x00\x002\x00\x00\x00g\x01\x00\x00\x00\x00\x01\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00(\xc1\x85}@\x00\x00\x04\x00\x08\x00\x00\x00\x00\x00\x00\x00\x01\x00\x04\x00\x01\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00@B\x0f\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xcd\xccL?\xf5\xca\x0b?\x00\x00zD\x00\x00\x00\x00\x00\x00\x08@\x00\x00\x00\x88\x83\xccH@\x00\x00\x00\x00\x00\x00\x00@\x00\x00\x00\x00\x00\x00\x10@\x00\x00\x04\x00\x00\x00\x00@\x01\x00\x00\x00\x00\x00\x80?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x01\x00\x00\x00\xe8\x03\x00\x00\x14\x00\x00\x00\x00\x01\x00\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 A\xcd\xccL?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00@@\x00\x00@@\x00\x00@@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

things_to_look_for = (
"CRYSTALLOGRAPHY ALPHAANGLEINDEG",
"CRYSTALLOGRAPHY BETAANGLEINDEG",
"GONIOMETER TYPE",
"ROTATION BEAM",
"ROTATION DETECTORORIENTATION",
"ROTATION ZEROCORRECTION")

def error_message(title="Test Title", message="Test message"):
    tk.messagebox.showinfo(title=title, message=message)
    exit()

def get_folders_with_par_file(path,template):
    folders = []
    for item in os.listdir(path):
        _ = os.path.join(path,item)
        if os.path.isdir(_):
            folders+=(get_folders_with_par_file(_,template))
        if os.path.splitext(_)[1] == ".par":
            if not os.path.samefile(_, template):
                folders.append(path)
    folder_set = set(folders)
    
    return list(folder_set)

file_path = filedialog.askopenfilename(defaultextension=".par",
                                       filetypes=([("Crysalis Parameter File", ".par")]),
                                       title="Please select template .par file")
if not file_path:
    error_message("No par file selected", "You did not select a par file, will abort now!")
proffitpars = os.path.join(os.path.dirname(file_path),"proffitbatch.proffitpars")
all_cells = os.path.join(os.path.dirname(file_path),"ALLCELLS.csv")
if not os.path.exists(proffitpars):
    o = open(proffitpars,"wb")
    o.write(byte_data)
    o.flush()
    o.close()

msg_box = tk.messagebox.askquestion('Provide proffitpars', 'Do you want to provide user selected options??')
if msg_box == 'yes':
    binary_file = filedialog.askopenfilename(defaultextension=".proffitpars",
                                   filetypes=([("Crysalis Proffit-Parameter File", ".proffitpars")]),
                                   title="Please select Proffitpars file")
    if not binary_file:
        error_message("No proffitpars file selected", "You did not select a proffitpars file, will abort now!")
    bf = open(binary_file,"rb")
    byte_data = bf.read()
    bf.close()
else:
    binary_file = None

work_folder = filedialog.askdirectory(title="Please select folder to look for measurements to prepare")
if not work_folder:
    exit()

all_folders = get_folders_with_par_file(work_folder,file_path)

template = []

with open(file_path) as template_par:
    for line in template_par.readlines():
        if any(x in line for x in things_to_look_for) and line[0] != 'ยง':
            template.append(line)

macro = open(os.path.join(work_folder,"proffitbatch.mac"),"w")
macro.write("XX SAVEUB\n")
for folder in all_folders:
    for item in os.listdir(folder):
        if item == "New.par":
            continue
        if os.path.splitext(item)[1] == ".par" and "cracker" not in item:
            if os.path.exists(os.path.join(folder, "New.par")):
                os.remove(os.path.join(folder, "New.par"))
            o = open(os.path.join(folder, "New.par"), "w")
            with open(os.path.join(folder, item), "r") as f:
                for i,line in enumerate(f.readlines()):
                    l = line
                    if any(x in line for x in things_to_look_for) and line[0] != 'ยง':
                        for temp in template:
                            if " ".join(temp.split()[:2]) in line:
                                l = temp
                                break
                    o.write(l)
            o.flush()
            o.close()
            shutil.move(os.path.join(folder, item),os.path.join(folder, "Old.par"))
            shutil.move(os.path.join(folder, "New.par"),os.path.join(folder, item))
            o = open(os.path.join(folder, "CrysalisExpSettings.ini"),"w")
            o.write(inifile)
            o.flush()
            o.close()
            macro.write("""XX SELECTEXPNOGUI "%s"\n"""%os.path.join(folder,os.path.splitext(item)[0]))
            macro.write("XX RECALLUB\n")
            macro.write("""XX PROFFIT FILE "%s"\n"""%os.path.splitext(proffitpars)[0])
            macro.write("""XX SAVEUB "%s"\n"""%all_cells)
            macro.flush()
            break
        elif os.path.splitext(item)[1] == ".par" and "cracker" in item:
            os.remove(os.path.join(folder,item))

macro.flush()
macro.close()